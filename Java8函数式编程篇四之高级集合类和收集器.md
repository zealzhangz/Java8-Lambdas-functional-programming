# ç¬¬5ç«  é«˜çº§é›†åˆç±»å’Œæ”¶é›†å™¨

ç¬¬3ç« åªä»‹ç»äº†é›†åˆç±»çš„éƒ¨åˆ†å˜åŒ–ï¼Œäº‹å®ä¸Šï¼Œ`Java 8` å¯¹é›†åˆç±»çš„æ”¹è¿›ä¸æ­¢è¿™äº›ã€‚ç°åœ¨æ˜¯æ—¶ å€™ä»‹ç»ä¸€äº›é«˜çº§ä¸»é¢˜äº†ï¼ŒåŒ…æ‹¬æ–°å¼•å…¥çš„ `Collector` ç±»ã€‚åŒæ—¶æˆ‘è¿˜ä¼šä¸ºå¤§å®¶ä»‹ç»æ–¹æ³•å¼•ç”¨ï¼Œå®ƒå¯ä»¥å¸®åŠ©å¤§å®¶åœ¨ `Lambda` è¡¨è¾¾å¼ä¸­è½»æ¾ä½¿ç”¨å·²æœ‰ä»£ç ã€‚ç¼–å†™å¤§é‡ä½¿ç”¨é›†åˆç±»çš„ä»£ç æ—¶ï¼Œ ä½¿ç”¨æ–¹æ³•å¼•ç”¨èƒ½è®©ç¨‹åºå‘˜è·å¾—ä¸°åšçš„å›æŠ¥ã€‚æœ¬ç« è¿˜ä¼šæ¶‰åŠé›†åˆç±»çš„ä¸€äº›æ›´é«˜çº§çš„ä¸»é¢˜ï¼Œæ¯” å¦‚æµä¸­å…ƒç´ çš„é¡ºåºï¼Œä»¥åŠä¸€äº›æœ‰ç”¨çš„ `API`ã€‚

## 5.1 æ–¹æ³•å¼•ç”¨
è¯»è€…å¯èƒ½å·²ç»å‘ç°ï¼Œ`Lambda` è¡¨è¾¾å¼æœ‰ä¸€ä¸ªå¸¸è§çš„ç”¨æ³•:`Lambda` è¡¨è¾¾å¼ç»å¸¸è°ƒç”¨å‚æ•°ã€‚æ¯”å¦‚æƒ³å¾—åˆ°è‰ºæœ¯å®¶çš„å§“åï¼Œ`Lambda` çš„è¡¨è¾¾å¼å¦‚ä¸‹:

```java
    artist -> artist.getName()
```

è¿™ç§ç”¨æ³•å¦‚æ­¤æ™®éï¼Œå› æ­¤ `Java 8` ä¸ºå…¶æä¾›äº†ä¸€ä¸ªç®€å†™è¯­æ³•ï¼Œå«ä½œæ–¹æ³•å¼•ç”¨ï¼Œå¸®åŠ©ç¨‹åºå‘˜é‡ç”¨å·²æœ‰æ–¹æ³•ã€‚ç”¨æ–¹æ³•å¼•ç”¨é‡å†™ä¸Šé¢çš„ `Lambda` è¡¨è¾¾å¼ï¼Œä»£ç å¦‚ä¸‹:

```java
    Artist::getName
```

æ ‡å‡†è¯­æ³•ä¸º `Classname::methodName`ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè™½ç„¶è¿™æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œä½†ä¸éœ€è¦åœ¨åé¢åŠ æ‹¬å·ï¼Œå› ä¸ºè¿™é‡Œå¹¶ä¸è°ƒç”¨è¯¥æ–¹æ³•ã€‚æˆ‘ä»¬åªæ˜¯æä¾›äº†å’Œ `Lambda` è¡¨è¾¾å¼ç­‰ä»·çš„ä¸€ç§ç»“æ„ï¼Œ åœ¨éœ€è¦æ—¶æ‰ä¼šè°ƒç”¨ã€‚å‡¡æ˜¯ä½¿ç”¨ `Lambda` è¡¨è¾¾å¼çš„åœ°æ–¹ï¼Œå°±å¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨ã€‚

æ„é€ å‡½æ•°ä¹Ÿæœ‰åŒæ ·çš„ç¼©å†™å½¢å¼ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨ `Lambda` è¡¨è¾¾å¼åˆ›å»ºä¸€ä¸ª `Artist` å¯¹è±¡ï¼Œå¯èƒ½ ä¼šå†™å‡ºå¦‚ä¸‹ä»£ç 

```java
    (name, nationality) -> new Artist(name, nationality)
```
ä½¿ç”¨æ–¹æ³•å¼•ç”¨ï¼Œä¸Šè¿°ä»£ç å¯å†™ä¸º:

```java
    Artist::new
```

è¿™æ®µä»£ç ä¸ä»…æ¯”åŸæ¥çš„ä»£ç çŸ­ï¼Œè€Œä¸”æ›´æ˜“é˜…è¯»ã€‚`Artist::new` ç«‹åˆ»å‘Šè¯‰ç¨‹åºå‘˜è¿™æ˜¯åœ¨åˆ›å»º ä¸€ä¸ª `Artist` å¯¹è±¡ï¼Œç¨‹åºå‘˜æ— éœ€çœ‹å®Œæ•´è¡Œä»£ç å°±èƒ½å¼„æ˜ç™½ä»£ç çš„æ„å›¾ã€‚å¦ä¸€ä¸ªè¦æ³¨æ„çš„åœ°æ–¹æ˜¯æ–¹æ³•å¼•ç”¨è‡ªåŠ¨æ”¯æŒå¤šä¸ªå‚æ•°ï¼Œå‰ææ˜¯é€‰å¯¹äº†æ­£ç¡®çš„å‡½æ•°æ¥å£ã€‚

è¿˜å¯ä»¥ç”¨è¿™ç§æ–¹å¼åˆ›å»ºæ•°ç»„ï¼Œä¸‹é¢çš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²å‹çš„æ•°ç»„:

```java
    String[]::new
```

ä»ç°åœ¨å¼€å§‹ï¼Œæˆ‘ä»¬å°†åœ¨åˆé€‚çš„åœ°æ–¹ä½¿ç”¨æ–¹æ³•å¼•ç”¨ï¼Œå› æ­¤è¯»è€…å¾ˆå¿«ä¼šçœ‹åˆ°æ›´å¤šçš„ä¾‹å­ã€‚ä¸€å¼€å§‹æ¢ç´¢ `Java 8` æ—¶ï¼Œæœ‰ä½æœ‹å‹å‘Šè¯‰æˆ‘ï¼Œæ–¹æ³•å¼•ç”¨çœ‹èµ·æ¥â€œå°±åƒåœ¨ä½œå¼Šâ€ã€‚ä»–çš„æ„æ€æ˜¯è¯´ï¼Œäº†è§£å¦‚ä½•ä½¿ç”¨ `Lambda` è¡¨è¾¾å¼è®©ä»£ç åƒæ•°æ®ä¸€æ ·åœ¨å¯¹è±¡é—´ä¼ é€’ä¹‹åï¼Œè¿™ç§ç›´æ¥å¼•ç”¨æ–¹æ³•çš„æ–¹å¼å°±åƒâ€œä½œå¼Šâ€ã€‚

æ”¾å¿ƒï¼Œè¿™ä¸æ˜¯åœ¨ä½œå¼Šã€‚è¯»è€…åªè¦è®°ä½ï¼Œæ¯æ¬¡å†™å‡ºå½¢å¦‚ `x -> a.foo(x)`çš„`Lambda`è¡¨è¾¾å¼æ—¶ï¼Œ å’Œç›´æ¥è°ƒç”¨æ–¹æ³• `foo` æ˜¯ä¸€æ ·çš„ã€‚æ–¹æ³•å¼•ç”¨åªä¸è¿‡æ˜¯åŸºäºè¿™æ ·çš„äº‹å®ï¼Œæä¾›äº†ä¸€ç§ç®€çŸ­çš„è¯­æ³•è€Œå·²ã€‚

```
x -> a.foo(x) <==> A::foo
```

## 5.2 å…ƒç´ é¡ºåº
å¦å¤–ä¸€ä¸ªå°šæœªæåŠçš„å…³äºé›†åˆç±»çš„å†…å®¹æ˜¯æµä¸­çš„å…ƒç´ ä»¥ä½•ç§é¡ºåºæ’åˆ—ã€‚è¯»è€…å¯èƒ½çŸ¥é“ï¼Œä¸€ äº›é›†åˆç±»å‹ä¸­çš„å…ƒç´ æ˜¯æŒ‰é¡ºåºæ’åˆ—çš„ï¼Œæ¯”å¦‚ `List`;è€Œå¦ä¸€äº›åˆ™æ˜¯æ— åºçš„ï¼Œæ¯”å¦‚ `HashSet`ã€‚ å¢åŠ äº†æµæ“ä½œåï¼Œé¡ºåºé—®é¢˜å˜å¾—æ›´åŠ å¤æ‚ã€‚

ç›´è§‚ä¸Šçœ‹ï¼Œæµæ˜¯æœ‰åºçš„ï¼Œå› ä¸ºæµä¸­çš„å…ƒç´ éƒ½æ˜¯æŒ‰é¡ºåºå¤„ç†çš„ã€‚è¿™ç§é¡ºåºç§°ä¸ºå‡ºç°é¡ºåºã€‚å‡ºç°é¡ºåºçš„å®šä¹‰ä¾èµ–äºæ•°æ®æºå’Œå¯¹æµçš„æ“ä½œã€‚

åœ¨ä¸€ä¸ªæœ‰åºé›†åˆä¸­åˆ›å»ºä¸€ä¸ªæµæ—¶ï¼Œæµä¸­çš„å…ƒç´ å°±æŒ‰å‡ºç°é¡ºåºæ’åˆ—ï¼Œå› æ­¤ï¼Œå¦‚ä¸‹ä»£ç æ€»æ˜¯å¯ä»¥é€šè¿‡ã€‚

- é¡ºåºæµ‹è¯•æ°¸è¿œé€šè¿‡

```java
    @Test
    public  void testStreamSort(){
        List<Integer> numbers = Arrays.asList(1,2,3,4);
        List<Integer> sameOrder = numbers.stream()
                                            .collect(Collectors.toList());
        assertEquals(numbers,sameOrder);

    }
```
å¦‚æœé›†åˆæœ¬èº«å°±æ˜¯æ— åºçš„ï¼Œç”±æ­¤ç”Ÿæˆçš„æµä¹Ÿæ˜¯æ— åºçš„ã€‚`HashSet` å°±æ˜¯ä¸€ç§æ— åºçš„é›†åˆï¼Œå› æ­¤ä¸èƒ½ä¿è¯å¦‚ä¸‹æ‰€ç¤ºçš„ç¨‹åºæ¯æ¬¡éƒ½é€šè¿‡ã€‚

```java
    @Test
    public  void testHashSetOrder(){
        Set<Integer> numbers = new HashSet<>(Arrays.asList(4,3,2,1));
        List<Integer> sameOrder = numbers.stream()
                                            .collect(Collectors.toList());
        assertEquals(Arrays.asList(4,3,2,1), sameOrder);
    }
```

æµçš„ç›®çš„ä¸ä»…æ˜¯åœ¨é›†åˆç±»ä¹‹é—´åšè½¬æ¢ï¼Œè€Œä¸”åŒæ—¶æä¾›äº†ä¸€ç»„å¤„ç†æ•°æ®çš„é€šç”¨æ“ä½œã€‚æœ‰äº›é›†åˆæœ¬èº«æ˜¯æ— åºçš„ï¼Œä½†è¿™äº›æ“ä½œæœ‰æ—¶ä¼šäº§ç”Ÿé¡ºåºï¼Œè¯•çœ‹å¦‚ä¸‹ä»£ç ã€‚

```java
    @Test
    public  void testStreamSort1(){
        Set<Integer> numbers = new HashSet<>(Arrays.asList(4,3,2,1));
        List<Integer> stillOrdered = numbers.stream()
                                            .sorted()
                                            .collect(Collectors.toList());
        assertEquals(Arrays.asList(1,2,3,4),stillOrdered);
    }
```

ä¸€äº›ä¸­é—´æ“ä½œä¼šäº§ç”Ÿé¡ºåºï¼Œæ¯”å¦‚å¯¹å€¼åšæ˜ å°„æ—¶ï¼Œæ˜ å°„åçš„å€¼æ˜¯æœ‰åºçš„ï¼Œè¿™ç§é¡ºåºå°±ä¼šä¿ç•™ä¸‹æ¥ã€‚å¦‚æœè¿›æ¥çš„æµæ˜¯æ— åºçš„ï¼Œå‡ºå»çš„æµä¹Ÿæ˜¯æ— åºçš„ã€‚çœ‹å¦‚ä¸‹ä»£ç ï¼Œæˆ‘ä»¬åªèƒ½æ–­è¨€`HashSet `ä¸­å«æœ‰æŸå…ƒç´ ï¼Œä½†å¯¹å…¶é¡ºåºä¸èƒ½ä½œå‡ºä»»ä½•å‡è®¾ï¼Œå› ä¸º `HashSet` æ˜¯æ— åºçš„ï¼Œä½¿ç”¨äº†æ˜ å°„æ“ä½œåï¼Œå¾—åˆ°çš„é›†åˆä»ç„¶æ˜¯æ— åºçš„ã€‚

```java
    @Test
    public  void testStreamMapSort(){
        List<Integer> numbers = Arrays.asList(1,2,3,4);
        List<Integer> stillOrdered = numbers.stream()
                                            .map(x->x+1)
                                            .collect(Collectors.toList());
        //é¡ºåºå¾—åˆ°äº†ä¿ç•™
        assertEquals(Arrays.asList(2, 3, 4, 5), stillOrdered);
        Set<Integer> unordered = new HashSet<>(numbers);
        List<Integer> stillUnordered = unordered.stream()
                                                .map(x->x+1)
                                                .collect(Collectors.toList());
        // é¡ºåºå¾—ä¸åˆ°ä¿è¯
        assertThat(stillUnordered, hasItem(2));
        assertThat(stillUnordered, hasItem(3));
        assertThat(stillUnordered, hasItem(4));
        assertThat(stillUnordered, hasItem(5));

    }
```

ä¸€äº›æ“ä½œåœ¨æœ‰åºçš„æµä¸Šå¼€é”€æ›´å¤§ï¼Œè°ƒç”¨ `unordered` æ–¹æ³•æ¶ˆé™¤è¿™ç§é¡ºåºå°±èƒ½è§£å†³è¯¥é—®é¢˜ã€‚å¤§å¤šæ•°æ“ä½œéƒ½æ˜¯åœ¨æœ‰åºæµä¸Šæ•ˆç‡æ›´é«˜ï¼Œæ¯”å¦‚ `filterã€map` å’Œ `reduce` ç­‰ã€‚

è¿™ä¼šå¸¦æ¥ä¸€äº›æ„æƒ³ä¸åˆ°çš„ç»“æœï¼Œæ¯”å¦‚ä½¿ç”¨å¹¶è¡Œæµæ—¶ï¼Œ`forEach` æ–¹æ³•ä¸èƒ½ä¿è¯å…ƒç´ æ˜¯ æŒ‰é¡ºåºå¤„ç†çš„(ç¬¬ 6 ç« ä¼šè¯¦ç»†è®¨è®ºè¿™äº›å†…å®¹)ã€‚å¦‚æœéœ€è¦ä¿è¯æŒ‰é¡ºåºå¤„ç†ï¼Œåº”è¯¥ä½¿ç”¨ `forEachOrdered` æ–¹æ³•ï¼Œå®ƒæ˜¯ä½ çš„æœ‹å‹ã€‚

## 5.3 ä½¿ç”¨æ”¶é›†å™¨
å‰é¢æˆ‘ä»¬ä½¿ç”¨è¿‡ `collect(toList())`ï¼Œåœ¨æµä¸­ç”Ÿæˆåˆ—è¡¨ã€‚æ˜¾ç„¶ï¼Œ`List` æ˜¯èƒ½æƒ³åˆ°çš„ä»æµä¸­ç”Ÿæˆçš„æœ€è‡ªç„¶çš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯æœ‰æ—¶äººä»¬è¿˜å¸Œæœ›ä»æµç”Ÿæˆå…¶ä»–å€¼ï¼Œæ¯”å¦‚ `Map` æˆ– `Set`ï¼Œæˆ–è€…ä½ å¸Œæœ›å®šåˆ¶ä¸€ä¸ªç±»å°†ä½ æƒ³è¦çš„ä¸œè¥¿æŠ½è±¡å‡ºæ¥ã€‚

å‰é¢å·²ç»è®²è¿‡ï¼Œä»…å‡­æµä¸Šæ–¹æ³•çš„ç­¾åï¼Œå°±èƒ½åˆ¤æ–­å‡ºè¿™æ˜¯å¦æ˜¯ä¸€ä¸ªåŠæ—©æ±‚å€¼çš„æ“ä½œã€‚`reduce` æ“ä½œå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œä½†æœ‰æ—¶äººä»¬å¸Œæœ›èƒ½åšå¾—æ›´å¤šã€‚

è¿™å°±æ˜¯æ”¶é›†å™¨ï¼Œä¸€ç§é€šç”¨çš„ã€ä»æµç”Ÿæˆå¤æ‚å€¼çš„ç»“æ„ã€‚åªè¦å°†å®ƒä¼ ç»™ `collect` æ–¹æ³•ï¼Œæ‰€æœ‰ çš„æµå°±éƒ½å¯ä»¥ä½¿ç”¨å®ƒäº†ã€‚

æ ‡å‡†ç±»åº“å·²ç»æä¾›äº†ä¸€äº›æœ‰ç”¨çš„æ”¶é›†å™¨ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ã€‚æœ¬ç« ç¤ºä¾‹ä»£ç ä¸­çš„æ”¶é›†å™¨éƒ½æ˜¯ä» `java.util.stream.Collectors` ç±»ä¸­é™æ€å¯¼å…¥çš„ã€‚

### 5.3.1 è½¬æ¢æˆå…¶ä»–é›†åˆ
æœ‰ä¸€äº›æ”¶é›†å™¨å¯ä»¥ç”Ÿæˆå…¶ä»–é›†åˆã€‚æ¯”å¦‚å‰é¢å·²ç»è§è¿‡çš„ `toList`ï¼Œç”Ÿæˆäº† `java.util.List` ç±» çš„å®ä¾‹ã€‚è¿˜æœ‰ `toSet` å’Œ `toCollection`ï¼Œåˆ†åˆ«ç”Ÿæˆ `Set` å’Œ `Collection` ç±»çš„å®ä¾‹ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ æˆ‘å·²ç»è®²äº†å¾ˆå¤šæµä¸Šçš„é“¾å¼æ“ä½œï¼Œä½†æ€»æœ‰ä¸€äº›æ—¶å€™ï¼Œéœ€è¦æœ€ç»ˆç”Ÿæˆä¸€ä¸ªé›†åˆâ€”â€”æ¯”å¦‚ï¼š
- å·²æœ‰ä»£ç æ˜¯ä¸ºé›†åˆç¼–å†™çš„ï¼Œå› æ­¤éœ€è¦å°†æµè½¬æ¢æˆé›†åˆä¼ å…¥;
- åœ¨é›†åˆä¸Šè¿›è¡Œä¸€ç³»åˆ—é“¾å¼æ“ä½œåï¼Œæœ€ç»ˆå¸Œæœ›ç”Ÿæˆä¸€ä¸ªå€¼;
- å†™å•å…ƒæµ‹è¯•æ—¶ï¼Œéœ€è¦å¯¹æŸä¸ªå…·ä½“çš„é›†åˆåšæ–­è¨€ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œåˆ›å»ºé›†åˆæ—¶éœ€è¦è°ƒç”¨é€‚å½“çš„æ„é€ å‡½æ•°æŒ‡æ˜é›†åˆçš„å…·ä½“ç±»å‹:

```java
    List<Artist> artists = new ArrayList<>();
```
ä½†æ˜¯è°ƒç”¨ `toList` æˆ–è€… `toSet` æ–¹æ³•æ—¶ï¼Œä¸éœ€è¦æŒ‡å®šå…·ä½“çš„ç±»å‹ã€‚`Stream` ç±»åº“åœ¨èƒŒåè‡ªåŠ¨ä¸ºä½ æŒ‘é€‰å‡ºäº†åˆé€‚çš„ç±»å‹ã€‚æœ¬ä¹¦åé¢ä¼šè®²è¿°å¦‚ä½•ä½¿ç”¨ `Stream` ç±»åº“å¹¶è¡Œå¤„ç†æ•°æ®ï¼Œæ”¶é›†å¹¶è¡Œæ“ä½œçš„ç»“æœéœ€è¦çš„ `Set`ï¼Œå’Œå¯¹çº¿ç¨‹å®‰å…¨æ²¡æœ‰è¦æ±‚çš„ `Set` ç±»æ˜¯å®Œå…¨ä¸åŒçš„ã€‚

å¯èƒ½è¿˜ä¼šæœ‰è¿™æ ·çš„æƒ…å†µï¼Œä½ å¸Œæœ›ä½¿ç”¨ä¸€ä¸ªç‰¹å®šçš„é›†åˆæ”¶é›†å€¼ï¼Œè€Œä¸”ä½ å¯ä»¥ç¨åæŒ‡å®šè¯¥é›†åˆçš„ç±»å‹ã€‚æ¯”å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›ä½¿ç”¨ `TreeSet`ï¼Œè€Œä¸æ˜¯ç”±æ¡†æ¶åœ¨èƒŒåè‡ªåŠ¨ä¸ºä½ æŒ‡å®šä¸€ç§ç±»å‹çš„ `Set`ã€‚æ­¤æ—¶å°±å¯ä»¥ä½¿ç”¨ `toCollection`ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œæ¥åˆ›å»ºé›†åˆå¦‚ä¸‹ä¾‹å­æ‰€ç¤ºï¼š

- ä½¿ç”¨ toCollectionï¼Œç”¨å®šåˆ¶çš„é›†åˆæ”¶é›†å…ƒç´ 

```java
    List<Integer> numbers =  Arrays.asList(1,2,3,4,1);
    TreeSet<Integer> treeSet = numbers.stream()
                                        .collect(Collectors.toCollection(TreeSet::new));
    assertEquals(treeSet.size(),numbers.size() - 1);
```

### 5.3.2 è½¬æ¢æˆå€¼
è¿˜å¯ä»¥åˆ©ç”¨æ”¶é›†å™¨è®©æµç”Ÿæˆä¸€ä¸ªå€¼ã€‚`maxBy` å’Œ `minBy` å…è®¸ç”¨æˆ·æŒ‰æŸç§ç‰¹å®šçš„é¡ºåºç”Ÿæˆä¸€ä¸ªå€¼ã€‚å¦‚ä¸‹ä»£ç å±•ç¤ºäº†å¦‚ä½•æ‰¾å‡ºæˆå‘˜æœ€å¤šçš„ä¹é˜Ÿã€‚å®ƒä½¿ç”¨ä¸€ä¸ª `Lambda` è¡¨è¾¾å¼ï¼Œå°†è‰ºæœ¯å®¶æ˜ å°„ä¸ºæˆå‘˜æ•°é‡ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªæ¯”è¾ƒå™¨ï¼Œå¹¶å°†æ¯”è¾ƒå™¨ä¼ å…¥ `maxBy` æ”¶é›†å™¨ã€‚

- æ‰¾å‡ºæˆå‘˜æœ€å¤šçš„ä¹é˜Ÿ

```java
    public Optional<Artist> biggestGroup(Stream<Artist> artists){
        Function<Artist,Long> getCount = artist -> artist.getMembers().count();
        return artists.collect(Collectors.maxBy(comparing(getCount)));
    }

```
`minBy` å°±å¦‚å®ƒçš„æ–¹æ³•åï¼Œæ˜¯ç”¨æ¥æ‰¾å‡ºæœ€å°å€¼çš„ã€‚

è¿˜æœ‰äº›æ”¶é›†å™¨å®ç°äº†ä¸€äº›å¸¸ç”¨çš„æ•°å€¼è¿ç®—ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªè®¡ç®—ä¸“è¾‘æ›²ç›®å¹³å‡æ•°çš„ä¾‹å­æ¥ çœ‹çœ‹

- æ‰¾å‡ºä¸€ç»„ä¸“è¾‘ä¸Šæ›²ç›®çš„å¹³å‡æ•°

```java
    public double averageNumberOfTracks(List<Album> albums) { return albums.stream()
            .collect(averagingInt(album -> album.getTracks().size()));
    }
```

å’Œä»¥å‰ä¸€æ ·ï¼Œé€šè¿‡è°ƒç”¨`stream`æ–¹æ³•è®©é›†åˆç”Ÿæˆæµï¼Œç„¶åè°ƒç”¨`collect`æ–¹æ³•æ”¶é›†ç»“æœã€‚ `averagingInt` æ–¹æ³•æ¥å—ä¸€ä¸ª `Lambda` è¡¨è¾¾å¼ä½œå‚æ•°ï¼Œå°†æµä¸­çš„å…ƒç´ è½¬æ¢æˆä¸€ä¸ªæ•´æ•°ï¼Œç„¶åå†è®¡ç®— å¹³å‡æ•°ã€‚è¿˜æœ‰å’Œ `double` å’Œ `long` ç±»å‹å¯¹åº”çš„é‡è½½æ–¹æ³•ï¼Œå¸®åŠ©ç¨‹åºå‘˜å°†å…ƒç´ è½¬æ¢æˆç›¸åº”ç±»å‹çš„å€¼ã€‚

ç¬¬ 4 ç« ä»‹ç»è¿‡ä¸€äº›ç‰¹æ®Šçš„æµï¼Œå¦‚ `IntStream`ï¼Œä¸ºæ•°å€¼è¿ç®—å®šä¹‰äº†ä¸€äº›é¢å¤–çš„æ–¹æ³•ã€‚äº‹å®ä¸Šï¼Œ `Java 8`ä¹Ÿæä¾›äº†èƒ½å®Œæˆç±»ä¼¼åŠŸèƒ½çš„æ”¶é›†å™¨ï¼Œå¦‚`averagingInt`ã€‚å¯ä»¥ä½¿ç”¨`summingInt`åŠå…¶é‡è½½æ–¹æ³•æ±‚å’Œã€‚`SummaryStatistics` ä¹Ÿå¯ä»¥ä½¿ç”¨ `summingInt` åŠå…¶ç»„åˆæ”¶é›†

### 5.3.3 æ•°æ®åˆ†å—
å¦å¤–ä¸€ä¸ªå¸¸ç”¨çš„æµæ“ä½œæ˜¯å°†å…¶åˆ†è§£æˆä¸¤ä¸ªé›†åˆã€‚å‡è®¾æœ‰ä¸€ä¸ªè‰ºæœ¯å®¶ç»„æˆçš„æµï¼Œä½ å¯èƒ½å¸Œæœ›å°†å…¶åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ç‹¬å”±æ­Œæ‰‹ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯ç”±å¤šäººç»„æˆçš„ä¹é˜Ÿã€‚å¯ä»¥ä½¿ç”¨ä¸¤æ¬¡è¿‡æ»¤æ“ä½œï¼Œåˆ†åˆ«è¿‡æ»¤å‡ºä¸Šè¿°ä¸¤ç§è‰ºæœ¯å®¶ã€‚

ä½†æ˜¯è¿™æ ·æ“ä½œèµ·æ¥æœ‰é—®é¢˜ã€‚é¦–å…ˆï¼Œä¸ºäº†æ‰§è¡Œä¸¤æ¬¡è¿‡æ»¤æ“ä½œï¼Œéœ€è¦æœ‰ä¸¤ä¸ªæµã€‚å…¶æ¬¡ï¼Œå¦‚æœè¿‡ æ»¤æ“ä½œå¤æ‚ï¼Œæ¯ä¸ªæµä¸Šéƒ½è¦æ‰§è¡Œè¿™æ ·çš„æ“ä½œï¼Œä»£ç ä¹Ÿä¼šå˜å¾—å†—ä½™ã€‚

å¹¸å¥½æˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ªæ”¶é›†å™¨ `partitioningBy`ï¼Œå®ƒæ¥å—ä¸€ä¸ªæµï¼Œå¹¶å°†å…¶åˆ†æˆä¸¤éƒ¨åˆ†å®ƒä½¿ç”¨ `Predicate` å¯¹è±¡åˆ¤æ–­ä¸€ä¸ªå…ƒç´ åº”è¯¥å±äºå“ªä¸ªéƒ¨åˆ†ï¼Œå¹¶æ ¹æ®å¸ƒå°”å€¼è¿”å›ä¸€ä¸ª`Map`åˆ°åˆ—è¡¨ã€‚å› æ­¤ï¼Œå¯¹äº`true List`ä¸­çš„å…ƒç´ ï¼Œ`Predicat`eè¿”å›`true`;å¯¹å…¶ä»–`List`ä¸­çš„ å…ƒç´ ï¼Œ`Predicate` è¿”å› `false`ã€‚

ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†ä¹é˜Ÿ(æœ‰å¤šä¸ªæˆå‘˜)å’Œç‹¬å”±æ­Œæ‰‹åˆ†å¼€äº†ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œåˆ†å—å‡½æ•°æŒ‡æ˜è‰ºæœ¯å®¶æ˜¯å¦ä¸ºç‹¬å”±æ­Œæ‰‹ã€‚

- å°†è‰ºæœ¯å®¶ç»„æˆçš„æµåˆ†æˆä¹é˜Ÿå’Œç‹¬å”±æ­Œæ‰‹ä¸¤éƒ¨åˆ†

```java
    public Map<Boolean, List<Artist>> bandsAndSolo(Stream<Artist> artists) {
        return artists.collect(partitioningBy(artist -> artist.isSolo()));
    }
```

- ä¹Ÿå¯ä»¥ä½¿ç”¨æ–¹æ³•å¼•ç”¨ä»£æ›¿ Lambda è¡¨è¾¾å¼

```java
    public Map<Boolean, List<Artist>> bandsAndSolo(Stream<Artist> artists) {
        return artists.collect(partitioningBy(Artist::isSolo);
    }
```

### 5.3.4 æ•°æ®åˆ†ç»„
æ•°æ®åˆ†ç»„æ˜¯ä¸€ç§æ›´è‡ªç„¶çš„åˆ†å‰²æ•°æ®æ“ä½œï¼Œä¸å°†æ•°æ®åˆ†æˆ `ture` å’Œ `false` ä¸¤éƒ¨åˆ†ä¸åŒï¼Œå¯ä»¥ä½¿ ç”¨ä»»æ„å€¼å¯¹æ•°æ®åˆ†ç»„ã€‚æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ªç”±ä¸“è¾‘ç»„æˆçš„æµï¼Œå¯ä»¥æŒ‰ä¸“è¾‘å½“ä¸­çš„ä¸»å”±å¯¹ä¸“è¾‘åˆ†ç»„ã€‚

- å”±å¯¹ä¸“è¾‘åˆ†ç»„

```java
    public Map<Artist, List<Album>> albumsByArtist(Stream<Album> albums) {
        return albums.collect(groupingBy(album -> album.getMainMusician()));
    }
```

å’Œå…¶ä»–ä¾‹å­ä¸€æ ·ï¼Œè°ƒç”¨æµçš„ `collect` æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªæ”¶é›†å™¨ã€‚`groupingBy` æ”¶é›†å™¨(å¦‚å›¾ 5-2 æ‰€ç¤º)æ¥å—ä¸€ä¸ªåˆ†ç±»å‡½æ•°ï¼Œç”¨æ¥å¯¹æ•°æ®åˆ†ç»„ï¼Œå°±åƒ `partitioningBy` ä¸€æ ·ï¼Œæ¥å—ä¸€ä¸ª `Predicate` å¯¹è±¡å°†æ•°æ®åˆ†æˆ `ture` å’Œ `false` ä¸¤éƒ¨åˆ†ã€‚æˆ‘ä»¬ä½¿ç”¨çš„åˆ†ç±»å™¨æ˜¯ä¸€ä¸ª `Function` å¯¹ è±¡ï¼Œå’Œ `map` æ“ä½œç”¨åˆ°çš„ä¸€æ ·ã€‚

__è¯»è€…å¯èƒ½çŸ¥é“SQLä¸­çš„group byæ“ä½œï¼Œæˆ‘ä»¬çš„æ–¹æ³•æ˜¯å’Œè¿™ç±»ä¼¼çš„ä¸€ä¸ªæ¦‚å¿µï¼Œåªä¸è¿‡åœ¨ Stream ç±»åº“ä¸­å®ç°äº†è€Œå·²ã€‚__

### 5.3.5 å­—ç¬¦ä¸²
å¾ˆå¤šæ—¶å€™ï¼Œæ”¶é›†æµä¸­çš„æ•°æ®éƒ½æ˜¯ä¸ºäº†åœ¨æœ€åç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚å‡è®¾æˆ‘ä»¬æƒ³å°†å‚ä¸åˆ¶ä½œä¸€å¼ ä¸“è¾‘çš„æ‰€æœ‰è‰ºæœ¯å®¶çš„åå­—è¾“å‡ºä¸ºä¸€ä¸ªæ ¼å¼åŒ–å¥½çš„åˆ—è¡¨ï¼Œä»¥ä¸“è¾‘  `Let It Be` ä¸ºä¾‹ï¼ŒæœŸæœ›çš„è¾“å‡º ä¸º:"[George Harrison, John Lennon, Paul McCartney, Ringo Starr, The Beatles]"ã€‚

åœ¨ `Java 8` è¿˜æœªå‘å¸ƒå‰ï¼Œå®ç°è¯¥åŠŸèƒ½çš„ä»£ç å¯èƒ½å¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚é€šè¿‡ä¸æ–­è¿­ä»£åˆ—è¡¨ï¼Œä½¿ç”¨ä¸€ ä¸ª  `StringBuilder` å¯¹è±¡æ¥è®°å½•ç»“æœã€‚æ¯ä¸€æ­¥éƒ½å–å‡ºä¸€ä¸ªè‰ºæœ¯å®¶çš„åå­—ï¼Œè¿½åŠ åˆ° `StringBuilder` å¯¹è±¡ã€‚

```java
    @Test
    public  void testAppend(){
        List<Artist> artists = new ArrayList<>();
        StringBuilder builder = new StringBuilder("[");
        for (Artist artist : artists) {
            if (builder.length() > 1) {
                builder.append(", ");
            }
            String name = artist.getName();
            builder.append(name);
        }
        builder.append("]");
        String result = builder.toString();
    }

```

æ˜¾ç„¶ï¼Œè¿™æ®µä»£ç ä¸æ˜¯éå¸¸å¥½ã€‚å¦‚æœä¸ä¸€æ­¥æ­¥è·Ÿè¸ªï¼Œå¾ˆéš¾çœ‹å‡ºè¿™æ®µä»£ç æ˜¯å¹²ä»€ä¹ˆçš„ã€‚ä½¿ç”¨ `Java 8` æä¾›çš„æµå’Œæ”¶é›†å™¨å°±èƒ½å†™å‡ºæ›´æ¸…æ™°çš„ä»£ç ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚

```java
    @Test
    public  void testStreamJoin(){
        List<Artist> artists = new ArrayList<>();
        String result = artists.stream()
                .map(Artist::getName)
                .collect(Collectors.joining(",", "[", "]"));
        
    }
```

è¿™é‡Œä½¿ç”¨ `map` æ“ä½œæå–å‡ºè‰ºæœ¯å®¶çš„å§“åï¼Œç„¶åä½¿ç”¨ `Collectors.joining` æ”¶é›†æµä¸­çš„å€¼ï¼Œè¯¥æ–¹æ³• å¯ä»¥æ–¹ä¾¿åœ°ä»ä¸€ä¸ªæµå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…è®¸ç”¨æˆ·æä¾›åˆ†éš”ç¬¦(ç”¨ä»¥åˆ†éš”å…ƒç´ )ã€å‰ç¼€å’Œåç¼€ã€‚

### 5.3.6 ç»„åˆæ”¶é›†å™¨
è™½ç„¶è¯»è€…ç°åœ¨çœ‹åˆ°çš„å„ç§æ”¶é›†å™¨å·²ç»å¾ˆå¼ºå¤§äº†ï¼Œä½†å¦‚æœå°†å®ƒä»¬ç»„åˆèµ·æ¥ï¼Œä¼šå˜å¾—æ›´å¼ºå¤§ã€‚

ä¹‹å‰æˆ‘ä»¬ä½¿ç”¨ä¸»å”±å°†ä¸“è¾‘åˆ†ç»„ï¼Œç°åœ¨æ¥è€ƒè™‘å¦‚ä½•è®¡ç®—ä¸€ä¸ªè‰ºæœ¯å®¶çš„ä¸“è¾‘æ•°é‡ã€‚ä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨å‰é¢çš„æ–¹æ³•å¯¹ä¸“è¾‘å…ˆåˆ†ç»„åè®¡æ•°ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚
- è®¡ç®—æ¯ä¸ªè‰ºæœ¯å®¶ä¸“è¾‘æ•°çš„ç®€å•æ–¹å¼

```java
Map<Artist, List<Album>> albumsByArtist
         = albums.collect(groupingBy(album -> album.getMainMusician()));
Map<Artist, Integer> numberOfAlbums = new HashMap<>(); 
for(Entry<Artist, List<Album>> entry : albumsByArtist.entrySet()) {
         numberOfAlbums.put(entry.getKey(), entry.getValue().size());
     }         
```

è¿™ç§æ–¹å¼çœ‹èµ·æ¥ç®€å•ï¼Œä½†å´æœ‰ç‚¹æ‚ä¹±æ— ç« ã€‚è¿™æ®µä»£ç ä¹Ÿæ˜¯å‘½ä»¤å¼çš„ä»£ç ï¼Œä¸èƒ½è‡ªåŠ¨é€‚åº”å¹¶ è¡ŒåŒ–æ“ä½œã€‚

è¿™é‡Œå®é™…ä¸Šéœ€è¦å¦å¤–ä¸€ä¸ªæ”¶é›†å™¨ï¼Œå‘Šè¯‰ `groupingBy` ä¸ç”¨ä¸ºæ¯ä¸€ä¸ªè‰ºæœ¯å®¶ç”Ÿæˆä¸€ä¸ªä¸“è¾‘åˆ—è¡¨ï¼Œåªéœ€è¦å¯¹ä¸“è¾‘è®¡æ•°å°±å¯ä»¥äº†ã€‚å¹¸å¥½ï¼Œæ ¸å¿ƒç±»åº“å·²ç»æä¾›äº†ä¸€ä¸ªè¿™æ ·çš„æ”¶é›†å™¨: `counting`ã€‚ä½¿ç”¨å®ƒï¼Œå¯å°†ä¸Šè¿°ä»£ç é‡å†™ä¸ºå¦‚ä¸‹ä»£ç çš„æ ·å­ã€‚

```java
    public static Map<Artist,Long> numberOfAlbums(Stream<Album> albums){
        return albums.collect(groupingBy(album -> album.getMainMusician(),counting()));
    }
```

`groupingBy` å…ˆå°†å…ƒç´ åˆ†æˆå—ï¼Œæ¯å—éƒ½ä¸åˆ†ç±»å‡½æ•° `getMainMusician` æä¾›çš„é”®å€¼ç›¸å…³è”ï¼Œç„¶åä½¿ç”¨ä¸‹æ¸¸çš„å¦ä¸€ä¸ªæ”¶é›†å™¨æ”¶é›†æ¯å—ä¸­çš„å…ƒç´ ï¼Œæœ€å¥½å°†ç»“æœæ˜ å°„ä¸ºä¸€ä¸ª `Map`ã€‚

è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸ªä¾‹å­ï¼Œè¿™æ¬¡æˆ‘ä»¬ä¸æƒ³ç”Ÿæˆä¸€ç»„ä¸“è¾‘ï¼Œåªå¸Œæœ›å¾—åˆ°ä¸“è¾‘åã€‚è¿™ä¸ªé—®é¢˜ä»ç„¶å¯ä»¥ç”¨å‰é¢çš„æ–¹æ³•è§£å†³ï¼Œå…ˆå°†ä¸“è¾‘åˆ†ç»„ï¼Œç„¶åå†è°ƒæ•´ç”Ÿæˆçš„ Map ä¸­çš„å€¼

- ä½¿ç”¨ç®€å•æ–¹å¼æ±‚æ¯ä¸ªè‰ºæœ¯å®¶çš„ä¸“è¾‘å

```java
    public static Map<Artist, List<String>> nameOfAlbumsDumb(Stream<Album> albums) {
        Map<Artist, List<Album>> albumsByArtist =
                albums.collect(groupingBy(album -> album.getMainMusician()));
        Map<Artist, List<String>> nameOfAlbums = new HashMap<>();
        for (Map.Entry<Artist, List<Album>> entry : albumsByArtist.entrySet()) {
            nameOfAlbums.put(entry.getKey(), entry.getValue()
                    .stream()
                    .map(Album::getName).collect(toList()));
        }
        return nameOfAlbums;
    }
```

åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥å†ä½¿ç”¨ä¸€ä¸ªæ”¶é›†å™¨ï¼Œç¼–å†™å‡ºæ›´å¥½ã€æ›´å¿«ã€æ›´å®¹æ˜“å¹¶è¡Œå¤„ç†çš„ä»£ç ã€‚æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œå¯ä»¥ä½¿ç”¨ `groupingBy` å°†ä¸“è¾‘æŒ‰ä¸»å”±åˆ†ç»„ï¼Œä½†æ˜¯å…¶è¾“å‡ºä¸ºä¸€ä¸ª `Map<Artist, List<Album>>` å¯¹è±¡ï¼Œå®ƒå°†æ¯ä¸ªè‰ºæœ¯å®¶å’Œä»–çš„ä¸“è¾‘åˆ—è¡¨å…³è”èµ·æ¥ï¼Œä½†è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯ä¸€ä¸ªåŒ…å«ä¸“è¾‘åçš„å­—ç¬¦ä¸²åˆ—è¡¨ã€‚

æ­¤æ—¶ï¼Œæˆ‘ä»¬çœŸæ­£æƒ³åšçš„æ˜¯å°†ä¸“è¾‘åˆ—è¡¨æ˜ å°„ä¸ºä¸“è¾‘ååˆ—è¡¨ï¼Œè¿™é‡Œä¸èƒ½ç›´æ¥ä½¿ç”¨æµçš„ `map` æ“ ä½œï¼Œå› ä¸ºåˆ—è¡¨æ˜¯ç”± `groupingBy` ç”Ÿæˆçš„ã€‚æˆ‘ä»¬éœ€è¦æœ‰ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥å‘Šè¯‰ `groupingBy` å°†å®ƒ çš„å€¼åšæ˜ å°„ï¼Œç”Ÿæˆæœ€ç»ˆç»“æœã€‚

æ¯ä¸ªæ”¶é›†å™¨éƒ½æ˜¯ç”Ÿæˆæœ€ç»ˆå€¼çš„ä¸€å‰‚è‰¯æ–¹ã€‚è¿™é‡Œéœ€è¦ä¸¤å‰‚é…æ–¹ï¼Œä¸€ä¸ªä¼ ç»™å¦ä¸€ä¸ªã€‚è°¢å¤©è°¢ åœ°ï¼Œ`Oracle` å…¬å¸çš„ç ”ç©¶å‘˜ä»¬å·²ç»è€ƒè™‘åˆ°è¿™ç§æƒ…å†µï¼Œä¸ºæˆ‘ä»¬æä¾›äº† `mapping` æ”¶é›†å™¨ã€‚

`mapping` å…è®¸åœ¨æ”¶é›†å™¨çš„å®¹å™¨ä¸Šæ‰§è¡Œç±»ä¼¼ `map` çš„æ“ä½œã€‚ä½†æ˜¯éœ€è¦æŒ‡æ˜ä½¿ç”¨ä»€ä¹ˆæ ·çš„é›†åˆç±» å­˜å‚¨ç»“æœï¼Œæ¯”å¦‚ `toList`ã€‚è¿™äº›æ”¶é›†å™¨å°±åƒä¹Œé¾Ÿå ç½—æ±‰ï¼Œé¾Ÿé¾Ÿç›¸é©®ä»¥è‡³æ— ç©·ã€‚

`mapping` æ”¶é›†å™¨å’Œ `map` æ–¹æ³•ä¸€æ ·ï¼Œæ¥å—ä¸€ä¸ª `Function` å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œç»è¿‡é‡æ„åçš„å¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚

```java
    public static Map<Artist, List<String>> nameOfAlbumsDumb1(Stream<Album> albums) {
        Map<Artist, List<String>> nameOfAlbums =
                albums.collect(groupingBy(Album::getMainMusician, mapping(Album::getName, toList())));
        return nameOfAlbums;
    }
```

è¿™ä¸¤ä¸ªä¾‹å­ä¸­æˆ‘ä»¬éƒ½ç”¨åˆ°äº†ç¬¬äºŒä¸ªæ”¶é›†å™¨ï¼Œç”¨ä»¥æ”¶é›†æœ€ç»ˆç»“æœçš„ä¸€ä¸ªå­é›†ã€‚è¿™äº›æ”¶é›†å™¨å«ä½œä¸‹æ¸¸æ”¶é›†å™¨ã€‚æ”¶é›†å™¨æ˜¯ç”Ÿæˆæœ€ç»ˆç»“æœçš„ä¸€å‰‚é…æ–¹ï¼Œä¸‹æ¸¸æ”¶é›†å™¨åˆ™æ˜¯ç”Ÿæˆéƒ¨åˆ†ç»“æœçš„é…æ–¹ï¼Œä¸»æ”¶é›†å™¨ä¸­ä¼šç”¨åˆ°ä¸‹æ¸¸æ”¶é›†å™¨ã€‚è¿™ç§ç»„åˆä½¿ç”¨æ”¶é›†å™¨çš„æ–¹å¼ï¼Œä½¿å¾—å®ƒä»¬åœ¨ `Stream` ç±»åº“ ä¸­çš„ä½œç”¨æ›´åŠ å¼ºå¤§ã€‚

é‚£äº›ä¸ºåŸºæœ¬ç±»å‹ç‰¹æ®Šå®šåˆ¶çš„å‡½æ•°ï¼Œå¦‚ `averagingInt`ã€`summarizingLong` ç­‰ï¼Œäº‹å®ä¸Šå’Œè°ƒç”¨ç‰¹æ®Š `Stream` ä¸Šçš„æ–¹æ³•æ˜¯ç­‰ä»·çš„ï¼ŒåŠ ä¸Šå®ƒä»¬æ˜¯ä¸ºäº†å°†å®ƒä»¬å½“ä½œä¸‹æ¸¸æ”¶é›†å™¨æ¥ä½¿ç”¨çš„ã€‚

### 5.3.7 é‡æ„å’Œå®šåˆ¶æ”¶é›†å™¨
å°½ç®¡åœ¨å¸¸ç”¨æµæ“ä½œé‡Œï¼Œ`Java` å†…ç½®çš„æ”¶é›†å™¨å·²ç»ç›¸å½“å¥½ç”¨ï¼Œä½†æ”¶é›†å™¨æ¡†æ¶æœ¬èº«æ˜¯æå…¶é€šç”¨çš„ã€‚`JDK` æä¾›çš„æ”¶é›†å™¨æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå®Œå…¨å¯ä»¥å®šåˆ¶è‡ªå·±çš„æ”¶é›†å™¨ï¼Œè€Œä¸”å®šåˆ¶èµ·æ¥ç›¸å½“ç®€å•ï¼Œè¿™å°±æ˜¯æœ¬èŠ‚è¦è®²çš„å†…å®¹ã€‚

è¯»è€…å¯èƒ½è¿˜æ²¡å¿˜è®°åœ¨ä¹‹å‰çš„ä»£ç ä¸­ï¼Œå¦‚ä½•ä½¿ç”¨ `Java 7` è¿æ¥å­—ç¬¦ä¸²ï¼Œå°½ç®¡å½¢å¼å¹¶ä¸ä¼˜é›…ã€‚è®©æˆ‘ä»¬é€æ­¥é‡æ„è¿™æ®µä»£ç ï¼Œæœ€ç»ˆç”¨åˆé€‚çš„æ”¶é›†å™¨å®ç°åŸæœ‰ä»£ç åŠŸèƒ½ã€‚åœ¨å·¥ä½œä¸­æ²¡æœ‰å¿…è¦è¿™æ ·åšï¼Œ `JDK` å·²ç»æä¾›äº†ä¸€ä¸ªå®Œç¾çš„æ”¶é›†å™¨ `joining`ã€‚è¿™é‡Œåªæ˜¯ä¸ºäº†å±•ç¤ºå¦‚ä½•å®šåˆ¶æ”¶é›†å™¨ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ `Java 8` æä¾›çš„æ–°åŠŸèƒ½æ¥é‡æ„é—ç•™ä»£ç ã€‚

- ä½¿ç”¨ `for` å¾ªç¯å’Œ `StringBuilder` æ ¼å¼åŒ–è‰ºæœ¯å®¶å§“å

```java
    List<Artist> artists = new ArrayList<>();
    StringBuilder builder = new StringBuilder("[");
    for (Artist artist : artists) {
        if (builder.length() > 1) {
            builder.append(", ");
        }
        String name = artist.getName();
        builder.append(name);
    }
    builder.append("]");
    String result = builder.toString();
```

æ˜¾ç„¶ï¼Œå¯ä»¥ä½¿ç”¨ `map` æ“ä½œï¼Œå°†åŒ…å«è‰ºæœ¯å®¶çš„æµæ˜ å°„ä¸ºåŒ…å«è‰ºæœ¯å®¶å§“åçš„æµã€‚å¦‚ä¸‹ä»£ç å±•ç¤ºäº† ä½¿ç”¨äº†æµçš„ `map` æ“ä½œé‡æ„åçš„ä»£ç ã€‚

```java
    List<Artist> artists = new ArrayList<>();
    StringBuilder builder = new StringBuilder("[");
    artists.stream().map(Artist::getName).forEach(name -> {
        if (builder.length() > 1)
            builder.append(", ");
        builder.append(name);
    });
    builder.append("]");
    String result = builder.toString();
```

å°†è‰ºæœ¯å®¶æ˜ å°„ä¸ºå§“åï¼Œå°±èƒ½æ›´å¿«çœ‹å‡ºæœ€ç»ˆæ˜¯è¦ç”Ÿæˆä»€ä¹ˆï¼Œè¿™æ ·ä»£ç çœ‹èµ·æ¥æ›´æ¸…æ¥šä¸€ç‚¹ã€‚å¯æƒœ `forEach` æ–¹æ³•çœ‹èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹ç¬¨é‡ï¼Œè¿™ä¸æˆ‘ä»¬é€šè¿‡ç»„åˆé«˜çº§æ“ä½œè®©ä»£ç å˜å¾—æ˜“è¯»çš„ç›®æ ‡ä¸ç¬¦ã€‚

æš‚ä¸”ä¸å¿…è€ƒè™‘å®šåˆ¶ä¸€ä¸ªæ”¶é›†å™¨ï¼Œè®©æˆ‘ä»¬æƒ³æƒ³æ€ä¹ˆé€šè¿‡æµä¸Šå·²æœ‰çš„æ“ä½œæ¥è§£å†³è¯¥é—®é¢˜ã€‚å’Œç”Ÿ æˆå­—ç¬¦ä¸²ç›®æ ‡æœ€è¿‘çš„æ“ä½œå°±æ˜¯ `reduce`ï¼Œä½¿ç”¨å®ƒå°†å¦‚ä¸‹çš„ä»£ç é‡æ„å¦‚ä¸‹ã€‚

- ä½¿ç”¨ reduce å’Œ StringBuilder æ ¼å¼åŒ–è‰ºæœ¯å®¶å§“å

```java
    StringBuilder reduced =
            artists.stream()
                    .map(Artist::getName)
                    .reduce(new StringBuilder(), (builder1, name) -> {
                        if (builder1.length() > 0) {
                            builder1.append(", ");
                        }
                        builder1.append(name);
                        return builder1;
                    }, (left, right) -> left.append(right));
    reduced.insert(0, "[");
    reduced.append("]");
    String result = reduced.toString();
```
__è¿™é‡Œæ¯”è¾ƒç–‘æƒ‘çš„æ˜¯ç¬¬ä¸‰ä¸ªå‚æ•°(left, right) -> left.append(right)ï¼Œè¿™é‡Œçš„leftå’Œrightæ˜¯æŒ‡ä»€ä¹ˆå‚æ•°ï¼Ÿ__

ä¸Šé¢ğŸ‘†çš„é—®é¢˜ï¼Œç»è¿‡è°ƒæŸ¥[è°ƒæŸ¥](https://www.cnblogs.com/h9527/p/5685439.html)ï¼Œå‘ç°åœ¨æ™®é€š `stream` ä¸­ç¬¬ä¸‰ä¸ª `lambda combiner`å¹¶ä¸ä¼šæ‰§è¡Œï¼Œè€Œåœ¨ `parallelStream`ä¸­ä¼šæ‰§è¡Œï¼Œå¦‚ä¸‹è§£é‡Šï¼š

>Executing this stream in parallel results in an entirely different execution behavior. Now the combiner is actually called. Since the accumulator is called in parallel, the combiner is needed to sum up the separate accumulated values.
>
>é€šè¿‡å¹¶è¡Œçš„æ–¹å¼æ‰§è¡Œä¸Šé¢çš„ stream æ“ä½œï¼Œå¾—åˆ°çš„æ˜¯å¦å¤–ä¸€ç§å®Œå…¨ä¸ç›¸åŒçš„æ‰§è¡ŒåŠ¨ä½œã€‚åœ¨å¹¶è¡Œ stream ä¸­ combiner æ–¹æ³•ä¼šè¢«è°ƒç”¨ã€‚è¿™æ˜¯ç”±äºç´¯åŠ å™¨æ˜¯è¢«å¹¶è¡Œè°ƒç”¨çš„ï¼Œå› æ­¤ç»„åˆå™¨éœ€è¦å¯¹åˆ†å¼€çš„ç´¯åŠ æ“ä½œè¿›è¡Œæ±‚å’Œã€‚

æˆ‘æ›¾ç»å¤©çœŸåœ°ä»¥ä¸ºä¸Šé¢çš„é‡æ„ä¼šè®©ä»£ç å˜å¾—æ›´æ¸…æ™°ï¼Œå¯æƒœæ°å¥½ç›¸åï¼Œä»£ç çœ‹èµ·æ¥æ¯”ä»¥ å‰æ›´ç³Ÿç³•ã€‚è®©æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ€ä¹ˆå›äº‹ã€‚å’Œå‰é¢çš„ä¾‹å­ä¸€æ ·ï¼Œéƒ½è°ƒç”¨äº† `stream` å’Œ `map` æ–¹ æ³•ï¼Œ`reduce` æ“ä½œç”Ÿæˆè‰ºæœ¯å®¶å§“ååˆ—è¡¨ï¼Œè‰ºæœ¯å®¶ä¸è‰ºæœ¯å®¶ä¹‹é—´ç”¨â€œ,â€åˆ†éš”ã€‚é¦–å…ˆåˆ›å»ºä¸€ ä¸ª `StringBuilder` å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ˜¯ `reduce` æ“ä½œçš„åˆå§‹çŠ¶æ€ï¼Œç„¶åä½¿ç”¨ `Lambda` è¡¨è¾¾å¼å°†å§“åè¿æ¥åˆ° `builder` ä¸Šã€‚`reduce` æ“ä½œçš„ç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿæ˜¯ä¸€ä¸ª `Lambda` è¡¨è¾¾å¼ï¼Œæ¥å—ä¸¤ä¸ª `StringBuilder` å¯¹è±¡åšå‚æ•°ï¼Œå°†ä¸¤è€…è¿æ¥èµ·æ¥ã€‚æœ€åæ·»åŠ å‰ç¼€å’Œåç¼€ã€‚

åœ¨æ¥ä¸‹æ¥çš„é‡æ„ä¸­ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ `reduc`e æ“ä½œï¼Œä¸è¿‡éœ€è¦å°†æ‚ä¹±æ— ç« çš„ä»£ç éšè—æ‰â€”â€”æˆ‘ çš„æ„æ€æ˜¯ä½¿ç”¨ä¸€ä¸ª `StringCombiner` ç±»å¯¹ç»†èŠ‚è¿›è¡ŒæŠ½è±¡ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚

- ä½¿ç”¨ `reduce` å’Œ `StringCombiner` ç±»æ ¼å¼åŒ–è‰ºæœ¯å®¶å§“å

```java
    @Test
    public  void testStringCombiner(){
        List<Artist> artists = Arrays.asList(new Artist("Zhangsan","China"),new Artist("Lisi","China"));
        StringCombiner combiner = artists.stream()
                .map(Artist::getName)
                .reduce(new StringCombiner(",","[","]"),
                        StringCombiner::add,
                        StringCombiner::merge);
        String result = combiner.toString();
    }
```

å°½ç®¡ä»£ç çœ‹èµ·æ¥å’Œä¸Šä¸ªä¾‹å­å¤§ç›¸å¾„åº­ï¼Œå…¶å®èƒŒååšçš„å·¥ä½œæ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬ä½¿ç”¨ `reduce` æ“ä½œå°†å§“åå’Œåˆ†éš”ç¬¦è¿æ¥æˆä¸€ä¸ª `StringBuilder` å¯¹è±¡ã€‚ä¸è¿‡è¿™æ¬¡è¿æ¥å§“åæ“ä½œè¢«ä»£ç†åˆ°äº† `StringCombiner.add` æ–¹æ³•ï¼Œè€Œè¿æ¥ä¸¤ä¸ªè¿æ¥å™¨æ“ä½œè¢« `StringCombiner.merge` æ–¹æ³•ä»£ç†ã€‚è®©æˆ‘ä»¬ç°åœ¨æ¥çœ‹çœ‹è¿™äº›æ–¹æ³•ï¼Œå…ˆä»ä¸‹é¢ä¸­çš„ `add` æ–¹æ³•å¼€å§‹ã€‚

- `add` æ–¹æ³•è¿”å›è¿æ¥æ–°å…ƒç´ åçš„ç»“æœ

```java
    public StringCombiner add(String element){
        if(areAtStart()){
            this.builder.append(this.prefix);
        } else {
            this.builder.append(this.delim);
        }
        builder.append(element);
        return this;
    }
```
`add` æ–¹æ³•åœ¨å†…éƒ¨å…¶å®å°†æ“ä½œä»£ç†ç»™ä¸€ä¸ª `StringBuilder` å¯¹è±¡ã€‚å¦‚æœåˆšå¼€å§‹è¿›è¡Œè¿æ¥ï¼Œåˆ™åœ¨æœ€ å‰é¢æ·»åŠ å‰ç¼€ï¼Œå¦åˆ™æ·»åŠ åˆ†éš”ç¬¦ï¼Œç„¶åå†æ·»åŠ æ–°çš„å…ƒç´ ã€‚è¿™é‡Œè¿”å›ä¸€ä¸ª `StringCombiner` å¯¹ è±¡ï¼Œå› ä¸ºè¿™æ˜¯ä¼ ç»™ `reduce` æ“ä½œæ‰€éœ€è¦çš„ç±»å‹ã€‚åˆå¹¶ä»£ç ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå†…éƒ¨å°†æ“ä½œä»£ç†ç»™ `StringBuilder` å¯¹è±¡ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚

- `merge` æ–¹æ³•è¿æ¥ä¸¤ä¸ª `StringCombiner` å¯¹è±¡

```java
    public StringCombiner merge(StringCombiner other){
        this.builder.append(other.builder);
        return this;
    }
```

`reduce` é˜¶æ®µçš„é‡æ„è¿˜å·®ä¸€å°æ­¥å°±å·®ä¸å¤šç»“æŸäº†ã€‚æˆ‘ä»¬è¦åœ¨æœ€åè°ƒç”¨ `toString` æ–¹æ³•ï¼Œå°†æ•´ä¸ªæ­¥éª¤ä¸²æˆä¸€ä¸ªæ–¹æ³•é“¾ã€‚è¿™å¾ˆç®€å•ï¼Œåªéœ€è¦æ’åˆ—å¥½ `reduce` ä»£ç ï¼Œå‡†å¤‡å¥½å°†å…¶è½¬æ¢ä¸º `Collector API` å°±è¡Œäº†

- ä½¿ç”¨ reduce æ“ä½œï¼Œå°†å·¥ä½œä»£ç†ç»™ StringCombiner å¯¹è±¡

```java
    List<Artist> artists = Arrays.asList(new Artist("Zhangsan","China"),new Artist("Lisi","China"));
    String result = artists.stream()
                .map(Artist::getName)
                .reduce(new StringCombiner(",","[","]"),
                        StringCombiner::add,
                        StringCombiner::merge).toString();
```

__æ³¨æ„ï¼šå®æµ‹å‘ç°ä½¿ç”¨ stream() çš„ç¡®ä¸ä¼šèµ° merge æ–¹æ³•ï¼Œè§£é‡ŠåŒä¸Š__

ç°åœ¨çš„ä»£ç çœ‹èµ·æ¥å·²ç»å·®ä¸å¤šå®Œç¾äº†ï¼Œä½†æ˜¯åœ¨ç¨‹åºä¸­è¿˜æ˜¯ä¸èƒ½é‡ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æƒ³å°† `reduce` æ“ä½œé‡æ„ä¸ºä¸€ä¸ªæ”¶é›†å™¨ï¼Œåœ¨ç¨‹åºä¸­çš„ä»»ä½•åœ°æ–¹éƒ½èƒ½ä½¿ç”¨ã€‚ä¸å¦¨å°†è¿™ä¸ªæ”¶é›†å™¨å«ä½œ `StringCollector`ï¼Œè®©æˆ‘ä»¬é‡æ„ä»£ç ä½¿ç”¨è¿™ä¸ªæ–°çš„æ”¶é›†å™¨ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚

- ä½¿ç”¨å®šåˆ¶çš„æ”¶é›†å™¨ `StringCollector` æ”¶é›†å­—ç¬¦ä¸²

```java
    String result =
        artists.stream()
            .map(Artist::getName)
            .collect(new StringCollector(", ", "[", "]"));
```

æ—¢ç„¶å·²ç»å°†æ‰€æœ‰å¯¹å­—ç¬¦ä¸²çš„è¿æ¥æ“ä½œä»£ç†ç»™äº†å®šåˆ¶çš„æ”¶é›†å™¨ï¼Œåº”ç”¨ç¨‹åºå°±ä¸éœ€è¦å…³å¿ƒ `StringCollector` å¯¹è±¡çš„ä»»ä½•å†…éƒ¨ç»†èŠ‚ï¼Œå®ƒå’Œæ¡†æ¶ä¸­å…¶ä»– `Collector` å¯¹è±¡ç”¨èµ·æ¥æ˜¯ä¸€æ ·çš„ã€‚

å…ˆæ¥å®ç° `Collector` æ¥å£å¦‚ä¸‹ä»£ç ï¼Œç”±äº `Collector` æ¥å£æ”¯æŒæ³›å‹ï¼Œå› æ­¤å…ˆå¾—ç¡®å®šä¸€äº›å…·ä½“çš„ç±»å‹:
- å¾…æ”¶é›†å…ƒç´ çš„ç±»å‹ï¼Œè¿™é‡Œæ˜¯ `String`;
- ç´¯åŠ å™¨çš„ç±»å‹ `StringCombiner`;
- æœ€ç»ˆç»“æœçš„ç±»å‹ï¼Œè¿™é‡Œä¾ç„¶æ˜¯ `String`;

- å®šä¹‰å­—ç¬¦ä¸²æ”¶é›†å™¨

```java
public class StringCollector implements Collector<String,StringCombiner,String> {}
```

ä¸€ä¸ªæ”¶é›†å™¨ç”±å››éƒ¨åˆ†ç»„æˆã€‚é¦–å…ˆæ˜¯ä¸€ä¸ª `Supplier`ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¥å‚æ–¹æ³•ï¼Œç”¨æ¥åˆ›å»ºå®¹å™¨ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°±æ˜¯ `StringCombiner`ã€‚å’Œ `reduce` æ“ä½œä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ç±»ä¼¼ï¼Œå®ƒæ˜¯åç»­æ“ä½œçš„åˆå€¼ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

- `Supplier` æ˜¯åˆ›å»ºå®¹å™¨çš„å·¥å‚

```java
    @Override
    public Supplier<StringCombiner> supplier() {
        return () -> new StringCombiner(delim, prefix, suffix);
    }
```

è®©æˆ‘ä»¬ä¸€è¾¹é˜…è¯»ä»£ç ï¼Œä¸€è¾¹çœ‹å›¾ï¼Œè¿™æ ·å°±èƒ½çœ‹æ¸…åˆ°åº•æ˜¯æ€ä¹ˆå·¥ä½œçš„ã€‚ç”±äºæ”¶é›†å™¨å¯ä»¥å¹¶è¡Œæ”¶é›†ï¼Œæˆ‘ä»¬è¦å±•ç¤ºçš„æ”¶é›†æ“ä½œåœ¨ä¸¤ä¸ªå®¹å™¨ä¸Š(æ¯”å¦‚ `StringCombiners` )å¹¶è¡Œè¿›è¡Œã€‚`StringCombiner` ä¸­çš„ `merge` æ–¹æ³•å°±æ˜¯ä¸ºäº†å¤„ç†æµå¹¶è¡Œçš„æƒ…å†µã€‚

æ”¶é›†å™¨çš„æ¯ä¸€ä¸ªç»„ä»¶éƒ½æ˜¯å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ç®­å¤´è¡¨ç¤ºï¼Œæµä¸­çš„å€¼ç”¨åœ†åœˆè¡¨ç¤ºï¼Œæœ€ç»ˆç”Ÿæˆçš„å€¼ç”¨æ¤­åœ†è¡¨ç¤ºã€‚æ”¶é›†æ“ä½œä¸€å¼€å§‹ï¼Œ`Supplier` å…ˆåˆ›å»ºå‡ºæ–°çš„å®¹å™¨

![StringCollector](https://www.zhangaoo.com/upload/2018/11/51jk212sk6j38r2685rduf766v.png)

æ”¶é›†å™¨çš„ `accumulator` çš„ä½œç”¨å’Œ `reduce` æ“ä½œçš„ç¬¬äºŒä¸ªå‚æ•°ä¸€æ ·ï¼Œå®ƒç»“åˆä¹‹å‰æ“ä½œçš„ç»“æœå’Œå½“å‰å€¼ï¼Œç”Ÿæˆå¹¶è¿”å›æ–°çš„å€¼ã€‚è¿™ä¸€é€»è¾‘å·²ç»åœ¨ `StringCombiner` çš„ `add` æ–¹æ³•ä¸­å¾—ä»¥å®ç°ï¼Œ ç›´æ¥å¼•ç”¨å°±å¥½äº†

```java
    @Override
    public BiConsumer<StringCombiner, String> accumulator() {
        return StringCombiner::add;
    }
```

è¿™é‡Œçš„ `accumulator` ç”¨æ¥å°†æµä¸­çš„å€¼å åŠ å…¥å®¹å™¨ä¸­å¦‚ä¸‹å›¾

![accumulator](https://www.zhangaoo.com/upload/2018/11/rg19rlag8giour2pb51q8munjq.png)

`combine` æ–¹æ³•å¾ˆåƒ `reduce` æ“ä½œçš„ç¬¬ä¸‰ä¸ªæ–¹æ³•ã€‚å¦‚æœæœ‰ä¸¤ä¸ªå®¹å™¨ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶åˆå¹¶ã€‚åŒæ ·ï¼Œåœ¨å‰é¢çš„é‡æ„ä¸­æˆ‘ä»¬å·²ç»å®ç°äº†è¯¥åŠŸèƒ½ï¼Œç›´æ¥ä½¿ç”¨ `StringCombiner.merge` æ–¹æ³•å°±è¡Œäº†

- combiner åˆå¹¶ä¸¤ä¸ªå®¹å™¨

```java
    @Override
    public BinaryOperator<StringCombiner> combiner() { 
        return StringCombiner::merge;
    }
```

åœ¨æ”¶é›†é˜¶æ®µï¼Œå®¹å™¨è¢« `combiner` æ–¹æ³•æˆå¯¹åˆå¹¶è¿›ä¸€ä¸ªå®¹å™¨ï¼Œç›´åˆ°æœ€ååªå‰©ä¸€ä¸ªå®¹å™¨ä¸ºæ­¢å¦‚ä¸‹å›¾

![alt](https://www.zhangaoo.com/upload/2018/11/2hmbm9gicqgrjo9b6e6jt9rcbn.png)

è¯»è€…å¯èƒ½è¿˜è®°å¾—ï¼Œåœ¨ä½¿ç”¨æ”¶é›†å™¨ä¹‹å‰ï¼Œé‡æ„çš„æœ€åä¸€æ­¥å°† `toString` æ–¹æ³•å†…è”åˆ°æ–¹æ³•é“¾çš„æœ«ç«¯ï¼Œè¿™å°±å°† `StringCombiner` è½¬æ¢æˆäº†æˆ‘ä»¬æƒ³è¦çš„å­—ç¬¦ä¸²

![alt](https://www.zhangaoo.com/upload/2018/11/vobmj2tf32gg2on2v7oc870ng8.png)

æ”¶é›†å™¨çš„ `finisher` æ–¹æ³•ä½œç”¨ç›¸åŒã€‚æˆ‘ä»¬å·²ç»å°†æµä¸­çš„å€¼å åŠ å…¥ä¸€ä¸ªå¯å˜å®¹å™¨ä¸­ï¼Œä½†è¿™è¿˜ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„æœ€ç»ˆç»“æœã€‚è¿™é‡Œè°ƒç”¨äº† `finisher` æ–¹æ³•ï¼Œä»¥ä¾¿è¿›è¡Œè½¬æ¢ã€‚åœ¨æˆ‘ä»¬æƒ³åˆ›å»ºå­—ç¬¦ä¸²ç­‰ä¸å¯å˜çš„å€¼æ—¶ç‰¹åˆ«æœ‰ç”¨ï¼Œè¿™é‡Œå®¹å™¨æ˜¯å¯å˜çš„

- `finisher` æ–¹æ³•è¿”å›æ”¶é›†æ“ä½œçš„æœ€ç»ˆç»“æœ

```java
    @Override
    public Function<StringCombiner, String> finisher() {
        return StringCombiner::toString;
    }
```

ä»æœ€åå‰©ä¸‹çš„å®¹å™¨ä¸­å¾—åˆ°æœ€ç»ˆç»“æœã€‚

å…³äºæ”¶é›†å™¨ï¼Œè¿˜æœ‰ä¸€ç‚¹ä¸€ç›´æ²¡æœ‰æåŠï¼Œé‚£å°±æ˜¯ç‰¹å¾ã€‚ç‰¹å¾æ˜¯ä¸€ç»„æè¿°æ”¶é›†å™¨çš„å¯¹è±¡ï¼Œæ¡†æ¶
å¯ä»¥å¯¹å…¶é€‚å½“ä¼˜åŒ–ã€‚`characteristics` æ–¹æ³•å®šä¹‰äº†ç‰¹å¾ï¼Œå®ç° `Collector` æ¥å£ï¼Œé™¤äº†å®ç°ä¸Šé¢å››ä¸ªæ¥å£è¿˜éœ€è¦å®ç° `Set<Characteristics> characteristics()` æ¥å£ã€‚

éœ€è¦æ³¨æ„ä¸Šé¢å®ç°çš„æ‰€æœ‰ä»£ç åªèµ·æ•™å­¦ç”¨é€”ï¼Œå¯¹äºæ‹¼æ¥å­—ç¬¦ä¸²çš„åŠŸèƒ½ç³»ç»Ÿæ–¹æ³• `java.util.StringJoiner` å·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†ã€‚

åšè¿™äº›ç»ƒä¹ çš„ä¸»è¦ç›®çš„ä¸ä»…åœ¨äºå±•ç¤ºå®šåˆ¶æ”¶é›†å™¨çš„å·¥ä½œåŸç†ï¼Œè€Œä¸”è¿˜åœ¨äºå¸®åŠ©è¯»è€…ç¼–å†™è‡ª å·±çš„æ”¶é›†å™¨ã€‚ç‰¹åˆ«æ˜¯ä½ æœ‰è‡ªå·±ç‰¹å®šé¢†åŸŸå†…çš„ç±»ï¼Œå¸Œæœ›ä»é›†åˆä¸­æ„å»ºä¸€ä¸ªæ“ä½œï¼Œè€Œæ ‡å‡†çš„é›† åˆç±»å¹¶æ²¡æœ‰æä¾›è¿™ç§æ“ä½œæ—¶ï¼Œå°±éœ€è¦å®šåˆ¶è‡ªå·±çš„æ”¶é›†å™¨ã€‚

ä»¥ `StringCombiner` ä¸ºä¾‹ï¼Œæ”¶é›†å€¼çš„å®¹å™¨å’Œæˆ‘ä»¬æƒ³è¦åˆ›å»ºçš„å€¼(å­—ç¬¦ä¸²)ä¸ä¸€æ ·ã€‚å¦‚æœæƒ³è¦æ”¶é›†çš„æ˜¯ä¸å¯å˜å¯¹è±¡ï¼Œè€Œä¸æ˜¯å¯å˜å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ç§æƒ…å†µå°±éå¸¸æ™®éï¼Œå¦åˆ™æ”¶é›†æ“ä½œçš„æ¯ä¸€ æ­¥éƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°å€¼ã€‚

æƒ³è¦æ”¶é›†çš„æœ€ç»ˆç»“æœå’Œå®¹å™¨ä¸€æ ·æ˜¯å®Œå…¨æœ‰å¯èƒ½çš„ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæ”¶é›†çš„æœ€ç»ˆç»“æœæ˜¯é›†åˆï¼Œ æ¯”å¦‚ `toList` æ”¶é›†å™¨ï¼Œå°±å±äºè¿™ç§æƒ…å†µã€‚

æ­¤æ—¶ï¼Œ`finisher` æ–¹æ³•ä¸éœ€è¦å¯¹å®¹å™¨åšä»»ä½•æ“ä½œã€‚æ›´æ­£å¼åœ°è¯´ï¼Œæ­¤æ—¶çš„ `finisher` æ–¹æ³•å…¶å®æ˜¯ `identity` å‡½æ•°:å®ƒè¿”å›ä¼ å…¥å‚æ•°çš„å€¼ã€‚å¦‚æœè¿™æ ·ï¼Œæ”¶é›†å™¨å°±å±•ç°å‡º `IDENTITY_FINISH` çš„ç‰¹å¾ï¼Œéœ€è¦ä½¿ç”¨ `characteristics` æ–¹æ³•å£°æ˜ã€‚

__å°ç»“ï¼šè¯»åˆ°è¿™é‡Œé’ˆå¯¹ä¸Šé¢çš„é—®é¢˜: è¿™é‡Œçš„ left å’Œ right æ˜¯æŒ‡ä»€ä¹ˆå‚æ•°ï¼Ÿï¼Œå› ä¸ºæµæ˜¯å¯ä»¥å¹¶è¡Œå¤„ç†çš„ï¼Œå› æ­¤åœ¨å¤„ç†å¹¶è¡Œ accumulator ç»“æœéœ€è¦ä¸€ä¸ª merge æ“ä½œã€‚ä¸Šé¢çš„å­—ç¬¦ä¸²æ”¶é›†å™¨å¹¶ä¸èƒ½å®Œå…¨å¤„ç†å¹¶è¡Œæµçš„æƒ…å†µï¼Œå› ä¸º merge æ“ä½œå¹¶æœªå®Œå…¨è€ƒè™‘å¹¶è¡Œæƒ…å†µä¸‹çš„ prefixã€suffix Merge æ“ä½œï¼Œåªæ˜¯ç®€å•çš„ append æ“ä½œã€‚__

### 5.3.8 å¯¹æ”¶é›†å™¨çš„å½’ä¸€åŒ–å¤„ç†
å°±åƒä¹‹å‰çœ‹åˆ°çš„é‚£æ ·ï¼Œå®šåˆ¶æ”¶é›†å™¨å…¶å®ä¸éš¾ï¼Œä½†å¦‚æœä½ æƒ³ä¸ºè‡ªå·±é¢†åŸŸå†…çš„ç±»å®šåˆ¶ä¸€ä¸ªæ”¶é›†å™¨ï¼Œä¸å¦¨è€ƒè™‘ä¸€ä¸‹å…¶ä»–æ›¿ä»£æ–¹æ¡ˆã€‚æœ€å®¹æ˜“æƒ³åˆ°çš„æ–¹æ¡ˆæ˜¯æ„å»ºè‹¥å¹²ä¸ªé›†åˆå¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ ç»™é¢†åŸŸå†…ç±»çš„æ„é€ å‡½æ•°ã€‚å¦‚æœé¢†åŸŸå†…çš„ç±»åŒ…å«å¤šç§é›†åˆï¼Œè¿™ç§æ–¹å¼åˆç®€å•åˆé€‚ç”¨ã€‚

å½“ç„¶ï¼Œå¦‚æœé¢†åŸŸå†…çš„ç±»æ²¡æœ‰è¿™äº›é›†åˆï¼Œéœ€è¦åœ¨å·²æœ‰æ•°æ®ä¸Šè®¡ç®—ï¼Œé‚£è¿™ç§æ–¹æ³•å°±ä¸åˆé€‚äº†ã€‚ ä½†å³ä½¿å¦‚æ­¤ï¼Œä¹Ÿä¸è§å¾—éœ€è¦å®šåˆ¶ä¸€ä¸ªæ”¶é›†å™¨ã€‚ä½ è¿˜å¯ä»¥ä½¿ç”¨ `reducing` æ”¶é›†å™¨ï¼Œå®ƒä¸ºæµä¸Šçš„å½’ä¸€æ“ä½œæä¾›äº†ç»Ÿä¸€å®ç°ã€‚å¦‚ä¸‹ä»£ç å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `reducing` æ”¶é›†å™¨ç¼–å†™å­—ç¬¦ä¸²å¤„ç†ç¨‹åºã€‚

è¿™å’Œä¸Šé¢çš„ä¾‹å­ä¸­è®²åˆ°çš„åŸºäº `reduce` æ“ä½œçš„å®ç°å¾ˆåƒï¼Œè¿™ç‚¹ä»æ–¹æ³•åä¸­å°±èƒ½çœ‹å‡ºã€‚ åŒºåˆ«åœ¨äº `Collectors.reducing` çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæˆ‘ä»¬ä¸ºæµä¸­æ¯ä¸ªå…ƒç´ åˆ›å»ºäº†å”¯ä¸€çš„ `StringCombiner`ã€‚å¦‚æœä½ è¢«è¿™ç§å†™æ³•å“åˆ°äº†ï¼Œæˆ–æ˜¯æ„Ÿåˆ°æ¶å¿ƒï¼Œä½ ä¸æ˜¯ä¸€ä¸ªäºº!è¿™ç§æ–¹å¼éå¸¸ä½æ•ˆï¼Œè¿™ä¹Ÿæ˜¯æˆ‘è¦å®šåˆ¶æ”¶é›†å™¨çš„åŸå› ä¹‹ä¸€ã€‚

```java
    String  result =
            artists.stream()
            .map(Artist::getName)
            .collect(Collectors.reducing(
                    new StringCombiner(",","[","]"),
                    name -> new StringCombiner(", ", "[", "]").add(name),
                    StringCombiner::merge
            )).toString();
```

## 5.4 ä¸€äº›ç»†èŠ‚
`Lambda` è¡¨è¾¾å¼çš„å¼•å…¥ä¹Ÿæ¨åŠ¨äº†ä¸€äº›æ–°æ–¹æ³•è¢«åŠ å…¥é›†åˆç±»ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ `Map` ç±»çš„ä¸€äº›å˜åŒ–ã€‚

æ„å»º `Map` æ—¶ï¼Œä¸ºç»™å®šå€¼è®¡ç®—é”®å€¼æ˜¯å¸¸ç”¨çš„æ“ä½œä¹‹ä¸€ï¼Œä¸€ä¸ªç»å…¸çš„ä¾‹å­å°±æ˜¯å®ç°ä¸€ä¸ªç¼“å­˜ã€‚ä¼ ç»Ÿçš„å¤„ç†æ–¹å¼æ˜¯å…ˆè¯•ç€ä» `Map` ä¸­å–å€¼ï¼Œå¦‚æœæ²¡æœ‰å–åˆ°ï¼Œåˆ›å»ºä¸€ä¸ªæ–°å€¼å¹¶è¿”å›ã€‚

å‡è®¾ä½¿ç”¨ `Map<String, Artist> artistCache` å®šä¹‰ç¼“å­˜ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨è´¹æ—¶çš„æ•°æ®åº“æ“ä½œæŸ¥è¯¢è‰ºæœ¯å®¶ä¿¡æ¯ï¼Œä»£ç å¯èƒ½å¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚

- ä½¿ç”¨æ˜¾å¼åˆ¤æ–­ç©ºå€¼çš„æ–¹å¼ç¼“å­˜

```java
public Artist getArtist(String name) { 
    Artist artist = artistCache.get(name); 
    if (artist == null) {
        artist = readArtistFromDB(name);
        artistCache.put(name, artist);
    }
return artist; 
}
```

`Java 8` å¼•å…¥äº†ä¸€ä¸ªæ–°æ–¹æ³• `computeIfAbsent`ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ª `Lambda` è¡¨è¾¾å¼ï¼Œå€¼ä¸å­˜åœ¨æ—¶ä½¿ç”¨è¯¥ `Lambda` è¡¨è¾¾å¼è®¡ç®—æ–°å€¼ã€‚ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œå¯å°†ä¸Šè¿°ä»£ç é‡å†™ä¸ºå¦‚ä¸‹æ‰€ç¤ºçš„å½¢å¼ã€‚

- ä½¿ç”¨ `computeIfAbsent` ç¼“å­˜
```java
public Artist getArtist(String name) {
    return artistCache.computeIfAbsent(name, this::readArtistFromDB);
}
```

ä½ å¯èƒ½è¿˜å¸Œæœ›åœ¨å€¼ä¸å­˜åœ¨æ—¶ä¸è®¡ç®—ï¼Œä¸º `Map` æ¥å£æ–°å¢çš„ `compute` å’Œ `computeIfAbsent` å°±èƒ½å¤„ç†è¿™äº›æƒ…å†µã€‚

åœ¨å·¥ä½œä¸­ï¼Œä½ å¯èƒ½å°è¯•è¿‡åœ¨ `Map` ä¸Šè¿­ä»£ã€‚è¿‡å»çš„åšæ³•æ˜¯ä½¿ç”¨ `value` æ–¹æ³•è¿”å›ä¸€ä¸ªå€¼çš„é›†åˆï¼Œ ç„¶ååœ¨é›†åˆä¸Šè¿­ä»£ã€‚è¿™æ ·çš„ä»£ç ä¸æ˜“è¯»ã€‚å¦‚ä¸‹ä»£ç å±•ç¤ºäº†æœ¬ç« æ—©äº›æ—¶å€™ä»‹ç»çš„ä¸€ç§æ–¹å¼ï¼Œåˆ›å»ºä¸€ä¸ª `Map`ï¼Œç„¶åç»Ÿè®¡æ¯ä¸ªè‰ºæœ¯å®¶ä¸“è¾‘çš„æ•°é‡ã€‚

- ä¸€ç§ä¸‘é™‹çš„è¿­ä»£ `Map` çš„æ–¹å¼

```java
Map<Artist, Integer> countOfAlbums = new HashMap<>(); 
for(Map.Entry<Artist, List<Album>> entry : albumsByArtist.entrySet()) {
    Artist artist = entry.getKey();
    List<Album> albums = entry.getValue();
    countOfAlbums.put(artist, albums.size());
}
```

è°¢å¤©è°¢åœ°ï¼Œ`Java 8` ä¸º `Map` æ¥å£æ–°å¢äº†ä¸€ä¸ª `forEach` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ª `BiConsumer` å¯¹è±¡ä¸ºå‚æ•°(è¯¥å¯¹è±¡æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œè¿”å›ç©º)ï¼Œé€šè¿‡å†…éƒ¨è¿­ä»£ç¼–å†™å‡ºæ˜“äºé˜…è¯»çš„ä»£ç ï¼Œå…³äºå†… éƒ¨è¿­ä»£è¯·å‚è€ƒ 3.1 èŠ‚ã€‚ä½¿ç”¨è¯¥æ–¹æ³•é‡å†™åçš„ä»£ç å¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚

- ä½¿ç”¨å†…éƒ¨è¿­ä»£éå† `Map` é‡Œçš„å€¼

```java
 Map<Artist, Integer> countOfAlbums = new HashMap<>();
     albumsByArtist.forEach((artist, albums) -> {
         countOfAlbums.put(artist, albums.size());
     });
```

## 5.5 è¦ç‚¹å›
- æ–¹æ³•å¼•ç”¨æ˜¯ä¸€ç§å¼•ç”¨æ–¹æ³•çš„è½»é‡çº§è¯­æ³•ï¼Œå½¢å¦‚: `ClassName::methodName`ã€‚
- æ”¶é›†å™¨å¯ç”¨æ¥è®¡ç®—æµçš„æœ€ç»ˆå€¼ï¼Œæ˜¯ `reduce` æ–¹æ³•çš„æ¨¡æ‹Ÿã€‚
- Java 8 æä¾›äº†æ”¶é›†å¤šç§å®¹å™¨ç±»å‹çš„æ–¹å¼ï¼ŒåŒæ—¶å…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ”¶é›†å™¨ã€‚(åƒå‰é¢ä½¿ç”¨çš„ `toList`ã€`toSet` éƒ½æ˜¯æ”¶é›†å™¨)

## 5.6 ç»ƒä¹ 
1. æ–¹æ³•å¼•ç”¨
å›é¡¾ç¬¬ 3 ç« ä¸­çš„ä¾‹å­ï¼Œä½¿ç”¨æ–¹æ³•å¼•ç”¨æ”¹å†™ä»¥ä¸‹æ–¹æ³•:
a. è½¬æ¢å¤§å†™çš„ `map` æ–¹æ³•;

```java
    List<String> collected = Stream.of("a", "b", "hello")
            .map(String::toUpperCase)
            .collect(toList());
```

b. ä½¿ç”¨ `reduce` å®ç° `count` æ–¹æ³•;

```java
    public static Map<String, Long> countWords(Stream<String> names) {
        return names.collect(groupingBy(name -> name, counting()));
    }

```

c. ä½¿ç”¨ `flatMap` è¿æ¥åˆ—è¡¨ã€‚

```java
 artists.stream()
        .flatMap(Artist::getMembers
        .reduce(0,(acc,members) -> member.count())
```

2. æ”¶é›†å™¨
a. æ‰¾å‡ºåå­—æœ€é•¿çš„è‰ºæœ¯å®¶ï¼Œåˆ†åˆ«ä½¿ç”¨æ”¶é›†å™¨å’Œç¬¬ 3 ç« ä»‹ç»è¿‡çš„ reduce é«˜é˜¶å‡½æ•°å®ç°ã€‚ç„¶åå¯¹æ¯”äºŒè€…çš„å¼‚åŒ:å“ªä¸€ç§æ–¹å¼å†™èµ·æ¥æ›´ç®€å•ï¼Œå“ªä¸€ç§æ–¹å¼è¯»èµ·æ¥æ›´ç®€å•?ä»¥ä¸‹é¢çš„å‚æ•°ä¸ºä¾‹ï¼Œè¯¥æ–¹æ³•çš„æ­£ç¡®è¿”å›å€¼ä¸º "Stuart Sutcliffe":

```java
Stream<String> names = Stream.of("John Lennon", "Paul McCartney",
          "George Harrison", "Ringo Starr", "Pete Best", "Stuart Sutcliffe");
```

- ä½¿ç”¨æ”¶é›†å™¨

```java
        Function<String,Integer> getLength = artistName -> artistName.length();
        Optional<String> name1 =  names.collect(Collectors.maxBy(comparing(getLength))).orElseThrow(RuntimeException::new);
        assertEquals("Stuart Sutcliffe",name1.get());
```

- ä½¿ç”¨ reduce é«˜é˜¶å‡½æ•°

```java
        String name = names.reduce("", (acc, ele) -> ele.length() > acc.length() ? ele : acc);
        assertEquals("Stuart Sutcliffe",name);
```

- åˆ†æï¼šè¯­ä¹‰ä¸Šæ”¶é›†å™¨æ¯”è¾ƒæ¸…æ™°ï¼Œæ–¹æ³•åç§°èƒ½å‡†ç¡®è¡¨è¾¾é¢„æœŸçš„æ“ä½œ

b. å‡è®¾ä¸€ä¸ªå…ƒç´ ä¸ºå•è¯çš„æµï¼Œè®¡ç®—æ¯ä¸ªå•è¯å‡ºç°çš„æ¬¡æ•°ã€‚å‡è®¾è¾“å…¥å¦‚ä¸‹ï¼Œåˆ™è¿”å›å€¼ä¸ºä¸€ ä¸ªå½¢å¦‚  [John â†’ 3, Paul â†’ 2, George â†’ 1] çš„Map:

```java
Stream<String> names = Stream.of("John", "Paul", "George", "John",
                                        "Paul", "John");
```

```java
    Stream<String> names = Stream.of("John", "Paul", "George", "John","Paul", "John");
    Map<String ,Long> result = names.collect(groupingBy(name -> name,counting()));
```

c. ç”¨ä¸€ä¸ªå®šåˆ¶çš„æ”¶é›†å™¨å®ç° `Collectors.groupingBy` æ–¹æ³•ï¼Œä¸éœ€è¦æä¾›ä¸€ä¸ªä¸‹æ¸¸æ”¶é›†å™¨ï¼Œåªéœ€å®ç°ä¸€ä¸ªæœ€ç®€å•çš„å³å¯ã€‚åˆ«çœ‹ JDK çš„æºç ï¼Œè¿™æ˜¯ä½œå¼Š!æç¤º:å¯ä»ä¸‹é¢è¿™è¡Œä»£
ç å¼€å§‹:

```java
//ä»¥ä¸‹æ˜¯å‚è€ƒç­”æ¡ˆï¼Œæƒ³äº†ä¸€ä¼šå®åœ¨æ²¡å¤ªæ˜ç¡®æ€è·¯
package com.insightfullogic.java8.answers.chapter5;

import java.util.*;
import java.util.function.BiConsumer;
import java.util.function.BinaryOperator;
import java.util.function.Function;
import java.util.function.Supplier;
import java.util.stream.Collector;

public class GroupingBy<T, K> implements Collector<T, Map<K, List<T>>, Map<K, List<T>>> {

    private final static Set<Characteristics> characteristics = new HashSet<>();
    static {
        characteristics.add(Characteristics.IDENTITY_FINISH);
    }

    private final Function<? super T, ? extends K> classifier;

    public GroupingBy(Function<? super T, ? extends K> classifier) {
        this.classifier = classifier;
    }

    @Override
    public Supplier<Map<K, List<T>>> supplier() {
        return HashMap::new;
    }

    @Override
    public BiConsumer<Map<K, List<T>>, T> accumulator() {
        return (map, element) -> {
            K key = classifier.apply(element);
            List<T> elements = map.computeIfAbsent(key, k -> new ArrayList<>());
            elements.add(element);
        };
    }
    @Override
    public BinaryOperator<Map<K, List<T>>> combiner() {
        return (left, right) -> {
            right.forEach((key, value) -> {
                left.merge(key, value, (leftValue, rightValue) -> {
                    leftValue.addAll(rightValue);
                    return leftValue;
                });
            });
            return left;
        };
    }
    @Override
    public Function<Map<K, List<T>>, Map<K, List<T>>> finisher() {
        return map -> map;
    }

    @Override
    public Set<Characteristics> characteristics() {
        return characteristics;
    }
}
```


3. æ”¹è¿›Map
ä½¿ç”¨ Map çš„ computeIfAbsent æ–¹æ³•é«˜æ•ˆè®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—ã€‚è¿™é‡Œçš„â€œé«˜æ•ˆâ€æ˜¯æŒ‡é¿å…å°†é‚£äº›è¾ƒå°çš„åºåˆ—é‡å¤è®¡ç®—å¤šæ¬¡ã€‚

```java
    public static Map<Integer,BigDecimal> fibCache = new HashMap<>();
    public static BigDecimal optimiseFib(Integer i){
        if (i == 1 || i== 2){
            return new BigDecimal(1);
        }
        Function<Integer,BigDecimal> compute = j -> {
            BigDecimal left = optimiseFib(j - 1);
            BigDecimal right = optimiseFib(j - 2);
            BigDecimal result =  left.add(right);
            fibCache.put(i,result);
            return result;
        };
        return fibCache.computeIfAbsent(i,compute);
    }

    @Test
    public  void testOptimiseFib(){
        System.out.println(optimiseFib(1500));
    }
```

- æ–æ³¢é‚£å¥‘æ•°åˆ—çš„è€Œå¤–æ¢ç´¢
å‘ç°ä½¿ç”¨ä¸Šé¢é€’å½’ä¸”åŠ  `map` ç¼“å­˜çš„æ–¹æ³•ï¼Œåœ¨è®¡ç®—ç¬¬ `2000` ä¸ªæ–æ³¢é‚£å¥‘æ•°çš„æ—¶å€™å°±æŠ¥æ ˆæº¢å‡ºäº†ï¼Œå¦‚æœä¸ä½¿ç”¨ç¼“å­˜å‘ç°æ±‚ç¬¬ `50` ä¸ªæ–æ³¢é‚£å¥‘æ•°éƒ½æ±‚ä¸å‡ºæ¥ã€‚
ç®€å•æƒ³äº†ä¸€ä¸‹ä½¿ç”¨ `for` å¾ªç¯æ¥åšï¼Œä½¿ç”¨ `List` æ¥å­˜å‚¨ç»“æœï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
    public static BigDecimal listCalcFib(Integer i) {
        if (i < 3) {
            return new BigDecimal(1);
        }
        List<BigDecimal> result = Lists.newArrayListWithExpectedSize(i - 1);
        result.add(new BigDecimal(1));
        result.add(new BigDecimal(1));

        for (int j = 2; j < i; j++) {
            result.add(result.get(j - 2).add(result.get(j - 1)));
        }
        return result.get(i - 1);
    }
```
æ­¤æ—¶å¯ä»¥æ±‚å‡ºç¬¬ `25w` ä¸ªæ–æ³¢é‚£å¥‘æ•°éœ€è¦ `4327ms` æ—¶é—´ï¼Œå†æ±‚ç¬¬ `30w` ä¸ªçš„æ—¶å€™æŠ¥äº†å †æº¢å‡ºï¼Œæ˜æ˜¾å†…å­˜ä¸å¤Ÿäº† `java.lang.OutOfMemoryError: Java heap space`ã€‚

è¿›ä¸€æ­¥æƒ³æŠŠ `List` æ¢æˆ `Array` æ˜¯ä¸æ˜¯èƒ½æå‡æ±‚è§£æ•ˆç‡ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
    public static BigDecimal arrayCalcFib(Integer i) {
        if (i < 3) {
            return new BigDecimal(1);
        }
        BigDecimal [] result = new BigDecimal[i];
        result[0] = new BigDecimal(1);
        result[1] = new BigDecimal(1);

        for (int j = 2; j < i; j++) {
            result[j] = result[j - 2].add(result[j - 1]);
        }
        return result[i - 1];
    }
```
å‘ç°å½“æ±‚è§£è¾ƒå°æ–æ³¢é‚£å¥‘æ•°æ¯”å¦‚ç¬¬ `1000` ä¸ªï¼Œ`List`éœ€è¦èŠ±è´¹ `12ms`ï¼Œè€Œæ•°ç»„åªè¦ `1ms`,ä½†æ˜¯å‘ç°å½“æ±‚å¾ˆå¤§ï¼Œæ¯”å¦‚ç¬¬ `20w` ä¸ªæ–æ³¢é‚£å¥‘æ•°ï¼Œç¬¬ä¸€æ¬¡æ±‚è§£ç«Ÿç„¶`Array` æ¯” `List` æ›´æ…¢ã€‚ä½†æ˜¯å†æ±‚è§£ä¸€æ¬¡ï¼Œ`List` èŠ±è´¹ `2822ms`ï¼Œ`Array` èŠ±è´¹ `2075ms`ã€‚çŒœæƒ³åº”è¯¥æ˜¯å¤§é‡ç”³è¯·å†…å­˜å¯¼è‡´å†…å­˜æ‰©å¼ èŠ±è´¹äº†ä¸å°‘æ—¶é—´ã€‚

ä»”ç»†ä¸€æƒ³æˆ‘å¹¶éœ€è¦å­˜å‚¨ `i-n` ä¹‹é—´çš„æ‰€æœ‰ç»“æœï¼Œåªéœ€è¦æ±‚è§£ç¬¬ `n` ä¸ªï¼Œé‚£æ˜¯ä¸æ˜¯ 3 ä¸ªå±€éƒ¨å˜é‡å°±èƒ½æå®šå‘¢ï¼Ÿç­”æ¡ˆå€¼è‚¯å®šçš„ï¼Œä»£ç å¦‚ä¸‹:

```java
    public static BigDecimal tmpVariableCalcFib(Integer i) {
        if (i < 3) {
            return new BigDecimal(1);
        }
        BigDecimal  result = new BigDecimal(0);
        BigDecimal first = new BigDecimal(1);
        BigDecimal second = new BigDecimal(1);

        for (int j = 2; j < i; j++) {
            result = first.add(second);
            first = second;
            second = result;
        }
        return result;
    }
```
ç»“æœæ˜¯ç¬¬ `100w` ä¸ªä¹Ÿå¯ä»¥æ±‚å‡ºï¼Œæ—¶é—´èŠ±äº† `21653ms`ã€‚è€Œæ±‚ç¬¬ `20w` åªéœ€è¦èŠ± `1348ms`,ç›¸æ¯” `Array` çš„ `2075ms` å¿«äº†ä¸å°‘ã€‚åˆ°è¿™ä¸ªæ—¶å€™èŠ±è´¹çš„å¤§éƒ¨åˆ†æ—¶é—´åº”è¯¥éƒ½æ˜¯å¾ªç¯ä¸­çš„å¤§æ•°åŠ æ³•ï¼Œå¦‚æœä¸ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜çš„è¯ï¼Œåº”è¯¥å¾ˆéš¾å†å¤§å¹…æé«˜äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä¸ç¦æƒ³æ¢å…¶ä»–è¯­è¨€è¯•è¯•ï¼Œæ¯”å¦‚ `golang`ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```golang
func calcFib(i int) *big.Int {
	if i < 3{
		return big.NewInt(1)
	}
	result,first,second := big.NewInt(0),big.NewInt(1),big.NewInt(1)
	for j := 2; j < i;j++{
		result = first.Add(first,second)
		first = second
		second = result
	}
	return result
}
```
ç»“æœåªèŠ±äº† `150.907815ms` ç®€ç›´äº®çç‹—çœ¼æœ‰æœ¨æœ‰ï¼ï¼ç›¸æ¯” `Java` æœ€å¿«çš„æˆç»© `1348ms` æé«˜äº†å°†è¿‘ä¸€ä¸ªæ•°é‡çº§ã€‚å†æ¥ç®—ä¸€ä¸‹ `100w` ä¸ªæ–æ³¢é‚£å¥‘æ•°ï¼Œç›¸æ¯” `Java` çš„ `21894ms`ï¼Œ`golang` åªèŠ±äº† `4191ms` ä¹Ÿæ˜¯ä¸€ä¸ªæ•°é‡çº§çš„å·®è·ã€‚éšæ‰‹è®¡ç®—äº†ä¸€ä¸‹ç¬¬ `200w` ä¸ªæ–æ³¢é‚£å¥‘æ•° `golang` èŠ±äº† `17063ms`ï¼Œå¤§å®¶çŒœç¬¬ `200w` æ–æ³¢é‚£å¥‘æ•°æœ‰å¤šé•¿ï¼Œç®€å•æ•°äº†ä¸€ä¸‹ `417975` ä½é•¿çš„æ•°å­—ã€‚è¯­è¨€å·®è·æœ‰å¦‚æ­¤ä¹‹å¤§å—ï¼Ÿåæ­£è¿œè¿œè¶…å‡ºäº†æˆ‘çš„é¢„æƒ³ã€‚å•å•ä»è¿™æ–¹é¢çœ‹ï¼Œ`golang` ç¡®å®æœ‰ç‚¹ç‰›é€¼å‘€ï¼ğŸ’¯
